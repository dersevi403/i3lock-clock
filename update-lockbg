#!/bin/sh
set -eu

###############################################################################
# library (convert-helper)
###############################################################################

composite_convert() {
    IN="${1:?input image required}"
    OUT="${2:?output image required}"
    RES=$(xdpyinfo | awk '/dimensions:/ {print $2}')

    ARGS=()
    [ -n "${BLUR:-}" ] && ARGS+=(-blur "$BLUR")

    convert "$IN" \
        -resize "${RES}"^ \
        -gravity center \
        -extent "${RES}" \
        "${ARGS[@]}" \
        "$OUT"
}

###############################################################################
# runner (main)
###############################################################################

main() {
    SCRIPT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"

    export CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/i3lock"
    mkdir -p "$CACHE"

    OUT="$CACHE/lock-wall.png"
    BLUR=""
		USE_BOX=0
    unset IN

    while getopts "i:o:b:" opt; do
        case "$opt" in
            i) IN="$OPTARG" ;;
            o) OUT="$OPTARG" ;;
            b) BLUR="$OPTARG" ;;
            *)
                echo "usage: $0 [-i input] [-o output] [-b blur]" >&2
                exit 1
                ;;
        esac
    done
    shift $((OPTIND - 1))

		[ -z "${IN:-}" ] && [ $# -gt 0 ] && IN="$1"
		[ -z "${OUT:-}" ] && [ $# -gt 1 ] && OUT="$2"

		if [ -z "${IN:-}" ]; then
				set -- "$SCRIPT_DIR"/sample-wall.*
				IN="$1"
		fi

		: "${IN:?no input image found}"

		composite_convert "$IN" "$OUT"
}

main "$@"
